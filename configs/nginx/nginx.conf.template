events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # 日志格式
    log_format main '\$remote_addr - \$remote_user [\$time_local] "\$request" '
                    '\$status \$body_bytes_sent "\$http_referer" '
                    '"\$http_user_agent" "\$http_x_forwarded_for"';
    
    # 基本配置
    sendfile        on;
    keepalive_timeout  65;
    server_tokens   off;
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # 上游服务器配置
    upstream v2ray {
        server v2ray:8080;
    }

    # HTTPS 服务器配置（端口 {{NGINX_PORT}}）
    server {
        listen {{NGINX_PORT}} ssl;
        http2 on;
        server_name {{DOMAIN}};

        # 访问日志
        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log warn;

        # SSL 证书配置
        ssl_certificate /etc/letsencrypt/live/{{DOMAIN}}/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/{{DOMAIN}}/privkey.pem;

        # SSL 安全配置
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4:!DH+3DES:!DHE-RSA-AES256-SHA;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;
        
        # HSTS
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        
        # 其他安全头
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # WebSocket 代理配置
        location {{WS_PATH}} {
            proxy_redirect off;
            proxy_pass http://v2ray;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
        }

        # 动态内容生成变量
        set $page_type "";
        set $user_agent_type "";
        
        # 根据时间和请求特征选择页面类型
        if ($time_local ~ "0[0-9]:|1[0-2]:") { set $page_type "tech"; }
        if ($time_local ~ "1[3-7]:") { set $page_type "company"; }
        if ($time_local ~ "1[8-9]:|2[0-3]:") { set $page_type "portfolio"; }
        
        # 根据User-Agent调整内容
        if ($http_user_agent ~ "Mobile|Android|iPhone") { set $user_agent_type "mobile"; }
        if ($http_user_agent ~ "bot|crawler|spider|Googlebot|Bingbot") { set $user_agent_type "bot"; }
        
        # 静态资源服务 - CSS样式
        location /assets/css/ {
            root {{V2RAY_DIR}};
            add_header Cache-Control "public, max-age=86400";
        }
        
        # JavaScript资源服务
        location /assets/js/ {
            root {{V2RAY_DIR}};
            add_header Cache-Control "public, max-age=86400";
        }
        
        # 图片资源404伪装
        location /images/ {
            return 404 '<!DOCTYPE html><html><head><title>404 Not Found</title></head><body><h1>404 Not Found</h1><p>The requested image was not found on this server.</p></body></html>';
            add_header Cache-Control "public, max-age=3600";
        }
        
        # API端点伪装
        location /api/status {
            return 200 '{"status":"active","uptime":"99.9%","last_check":"$time_iso8601","version":"1.2.3"}';
            add_header Content-Type application/json;
        }
        
        location /api/health {
            return 200 '{"healthy":true,"services":{"database":"up","cache":"up","storage":"up"},"timestamp":"$time_iso8601"}';
            add_header Content-Type application/json;
        }
        
        location /favicon.ico {
            return 204;
            add_header Cache-Control "public, max-age=86400";
        }
        
        location /robots.txt {
            return 200 'User-agent: *\nAllow: /\nDisallow: /admin/\nDisallow: /api/private/\nSitemap: https://\$host:\$server_port/sitemap.xml';
            add_header Content-Type text/plain;
        }

        # 技术博客页面模板
        location @tech_blog {
            try_files /dev/null @serve_tech_blog;
        }

        location @serve_tech_blog {
            root {{V2RAY_DIR}};
            try_files /assets/html/tech-blog.html =404;
            add_header Content-Type text/html;
            add_header Cache-Control "public, max-age=3600";
        }

        # 公司主页模板  
        location @company_site {
            try_files /dev/null @serve_company_site;
        }

        location @serve_company_site {
            root {{V2RAY_DIR}};
            try_files /assets/html/company-site.html =404;
            add_header Content-Type text/html;
            add_header Cache-Control "public, max-age=3600";
        }

        # 个人作品集模板
        location @portfolio_site {
            try_files /dev/null @serve_portfolio_site;
        }

        location @serve_portfolio_site {
            root {{V2RAY_DIR}};
            try_files /assets/html/portfolio-site.html =404;
            add_header Content-Type text/html;
            add_header Cache-Control "public, max-age=3600";
        }

        # 搜索引擎爬虫专用页面
        location @bot_page {
            return 200 '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>{{DOMAIN}} - Professional Technology Services</title><meta name="description" content="Professional technology consulting, software development, and digital solutions. Specializing in cloud architecture, web development, and enterprise solutions."><meta name="keywords" content="technology consulting, software development, web development, cloud solutions, enterprise services"><meta name="robots" content="index, follow"><link rel="canonical" href="https://{{DOMAIN}}:{{NGINX_PORT}}/"><meta property="og:title" content="{{DOMAIN}} - Technology Solutions"><meta property="og:description" content="Professional technology services and consulting for modern businesses"><meta property="og:type" content="website"><meta property="og:url" content="https://{{DOMAIN}}:{{NGINX_PORT}}/"><meta property="og:site_name" content="{{DOMAIN}}"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="{{DOMAIN}} - Technology Solutions"><meta name="twitter:description" content="Professional technology services and consulting"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","name":"{{DOMAIN}}","url":"https://{{DOMAIN}}:{{NGINX_PORT}}","description":"Professional technology consulting and software development services","contactPoint":{"@type":"ContactPoint","contactType":"customer service","email":"contact@{{DOMAIN}}"},"sameAs":["https://linkedin.com/company/{{DOMAIN}}","https://github.com/{{DOMAIN}}"]}</script></head><body><header><h1>Welcome to {{DOMAIN}}</h1><nav><ul><li><a href="/services">Services</a></li><li><a href="/about">About</a></li><li><a href="/portfolio">Portfolio</a></li><li><a href="/blog">Blog</a></li><li><a href="/contact">Contact</a></li></ul></nav></header><main><section><h2>🛠️ Our Services</h2><ul><li><strong>Web Development:</strong> Modern, responsive websites and web applications</li><li><strong>Mobile Applications:</strong> Cross-platform mobile solutions for iOS and Android</li><li><strong>Cloud Solutions:</strong> Scalable cloud architecture and migration services</li><li><strong>Digital Consulting:</strong> Strategic technology consulting for digital transformation</li><li><strong>Software Integration:</strong> API development and third-party integrations</li><li><strong>Maintenance & Support:</strong> Ongoing technical support and system maintenance</li></ul></section><section><h2>💡 Why Choose Us</h2><p>With extensive experience in modern technology solutions, we deliver high-quality, scalable results that drive business growth. Our team specializes in:</p><ul><li>✅ Agile development methodologies</li><li>✅ Cloud-native architectures</li><li>✅ Security-first approach</li><li>✅ Performance optimization</li><li>✅ Continuous integration and deployment</li></ul></section><section><h2>🏢 Industry Experience</h2><p>We have successfully delivered projects across various industries including:</p><p><strong>E-commerce, FinTech, HealthTech, Education, Enterprise SaaS, Media & Entertainment</strong></p></section><section><h2>📞 Contact Information</h2><p>Ready to discuss your next project? Get in touch with our team:</p><ul><li>📧 Email: contact@{{DOMAIN}}</li><li>📞 Phone: Available upon request</li><li>🌐 Website: https://{{DOMAIN}}:{{NGINX_PORT}}</li><li>📍 Serving clients globally</li></ul></section></main><footer><p>&copy; 2024 {{DOMAIN}}. All rights reserved.</p><nav><ul><li><a href="/privacy">Privacy Policy</a></li><li><a href="/terms">Terms of Service</a></li><li><a href="/sitemap.xml">Sitemap</a></li></ul></nav></footer></body></html>';
            add_header Content-Type text/html;
            add_header Cache-Control "public, max-age=7200";
        }

        # 主页面路由逻辑 - 动态内容生成
        location / {
            # 搜索引擎爬虫优先处理（SEO优化）
            if ($user_agent_type = "bot") {
                try_files $uri @bot_page;
            }
            
            # 根据时间段选择不同的网站类型
            if ($page_type = "tech") {
                try_files $uri @tech_blog;
            }
            if ($page_type = "company") {
                try_files $uri @company_site;
            }
            if ($page_type = "portfolio") {
                try_files $uri @portfolio_site;
            }
            
            # 默认回退到技术博客页面
            try_files $uri @tech_blog;
        }

        # 健康检查接口
        location /health {
            return 200 '{"status":"ok","timestamp":"$time_iso8601","tls":true}';
            add_header Content-Type application/json;
        }
    }

    # HTTP 重定向到 HTTPS
    server {
        listen 80;
        server_name {{DOMAIN}};
        
        # ACME 质询路径
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }
        
        # 其他请求重定向到 HTTPS
        location / {
            return 301 https://$server_name:{{NGINX_PORT}}$request_uri;
        }
    }
}