events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # æ—¥å¿—æ ¼å¼
    log_format main '\$remote_addr - \$remote_user [\$time_local] "\$request" '
                    '\$status \$body_bytes_sent "\$http_referer" '
                    '"\$http_user_agent" "\$http_x_forwarded_for"';
    
    # åŸºæœ¬é…ç½®
    sendfile        on;
    keepalive_timeout  65;
    server_tokens   off;
    
    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # ä¸Šæ¸¸æœåŠ¡å™¨é…ç½®
    upstream v2ray {
        server v2ray:8080;
    }

    # HTTPS æœåŠ¡å™¨é…ç½®ï¼ˆç«¯å£ {{NGINX_PORT}}ï¼‰
    server {
        listen {{NGINX_PORT}} ssl;
        http2 on;
        server_name {{DOMAIN}};

        # è®¿é—®æ—¥å¿—
        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log warn;

        # SSL è¯ä¹¦é…ç½®
        ssl_certificate /etc/letsencrypt/live/{{DOMAIN}}/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/{{DOMAIN}}/privkey.pem;

        # SSL å®‰å…¨é…ç½®
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4:!DH+3DES:!DHE-RSA-AES256-SHA;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;
        
        # HSTS
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        
        # å…¶ä»–å®‰å…¨å¤´
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # WebSocket ä»£ç†é…ç½®
        location {{WS_PATH}} {
            proxy_redirect off;
            proxy_pass http://v2ray;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
        }

        # åŠ¨æ€å†…å®¹ç”Ÿæˆå˜é‡
        set $page_type "";
        set $user_agent_type "";
        
        # æ ¹æ®æ—¶é—´å’Œè¯·æ±‚ç‰¹å¾é€‰æ‹©é¡µé¢ç±»å‹
        if ($time_local ~ "0[0-9]:|1[0-2]:") { set $page_type "tech"; }
        if ($time_local ~ "1[3-7]:") { set $page_type "company"; }
        if ($time_local ~ "1[8-9]:|2[0-3]:") { set $page_type "portfolio"; }
        
        # æ ¹æ®User-Agentè°ƒæ•´å†…å®¹
        if ($http_user_agent ~ "Mobile|Android|iPhone") { set $user_agent_type "mobile"; }
        if ($http_user_agent ~ "bot|crawler|spider|Googlebot|Bingbot") { set $user_agent_type "bot"; }
        
        # é™æ€èµ„æºæœåŠ¡ - CSSæ ·å¼
        location /assets/css/ {
            root {{V2RAY_DIR}};
            add_header Cache-Control "public, max-age=86400";
        }
        
        # JavaScriptèµ„æºæœåŠ¡
        location /assets/js/ {
            root {{V2RAY_DIR}};
            add_header Cache-Control "public, max-age=86400";
        }
        
        # å›¾ç‰‡èµ„æº404ä¼ªè£…
        location /images/ {
            return 404 '<!DOCTYPE html><html><head><title>404 Not Found</title></head><body><h1>404 Not Found</h1><p>The requested image was not found on this server.</p></body></html>';
            add_header Cache-Control "public, max-age=3600";
        }
        
        # APIç«¯ç‚¹ä¼ªè£…
        location /api/status {
            return 200 '{"status":"active","uptime":"99.9%","last_check":"$time_iso8601","version":"1.2.3"}';
            add_header Content-Type application/json;
        }
        
        location /api/health {
            return 200 '{"healthy":true,"services":{"database":"up","cache":"up","storage":"up"},"timestamp":"$time_iso8601"}';
            add_header Content-Type application/json;
        }
        
        location /favicon.ico {
            return 204;
            add_header Cache-Control "public, max-age=86400";
        }
        
        location /robots.txt {
            return 200 'User-agent: *\nAllow: /\nDisallow: /admin/\nDisallow: /api/private/\nSitemap: https://\$host:\$server_port/sitemap.xml';
            add_header Content-Type text/plain;
        }

        # æŠ€æœ¯åšå®¢é¡µé¢æ¨¡æ¿
        location @tech_blog {
            try_files /dev/null @serve_tech_blog;
        }

        location @serve_tech_blog {
            root {{V2RAY_DIR}};
            try_files /assets/html/tech-blog.html =404;
            add_header Content-Type text/html;
            add_header Cache-Control "public, max-age=3600";
        }

        # å…¬å¸ä¸»é¡µæ¨¡æ¿  
        location @company_site {
            try_files /dev/null @serve_company_site;
        }

        location @serve_company_site {
            root {{V2RAY_DIR}};
            try_files /assets/html/company-site.html =404;
            add_header Content-Type text/html;
            add_header Cache-Control "public, max-age=3600";
        }

        # ä¸ªäººä½œå“é›†æ¨¡æ¿
        location @portfolio_site {
            try_files /dev/null @serve_portfolio_site;
        }

        location @serve_portfolio_site {
            root {{V2RAY_DIR}};
            try_files /assets/html/portfolio-site.html =404;
            add_header Content-Type text/html;
            add_header Cache-Control "public, max-age=3600";
        }

        # æœç´¢å¼•æ“çˆ¬è™«ä¸“ç”¨é¡µé¢
        location @bot_page {
            return 200 '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>{{DOMAIN}} - Professional Technology Services</title><meta name="description" content="Professional technology consulting, software development, and digital solutions. Specializing in cloud architecture, web development, and enterprise solutions."><meta name="keywords" content="technology consulting, software development, web development, cloud solutions, enterprise services"><meta name="robots" content="index, follow"><link rel="canonical" href="https://{{DOMAIN}}:{{NGINX_PORT}}/"><meta property="og:title" content="{{DOMAIN}} - Technology Solutions"><meta property="og:description" content="Professional technology services and consulting for modern businesses"><meta property="og:type" content="website"><meta property="og:url" content="https://{{DOMAIN}}:{{NGINX_PORT}}/"><meta property="og:site_name" content="{{DOMAIN}}"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="{{DOMAIN}} - Technology Solutions"><meta name="twitter:description" content="Professional technology services and consulting"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","name":"{{DOMAIN}}","url":"https://{{DOMAIN}}:{{NGINX_PORT}}","description":"Professional technology consulting and software development services","contactPoint":{"@type":"ContactPoint","contactType":"customer service","email":"contact@{{DOMAIN}}"},"sameAs":["https://linkedin.com/company/{{DOMAIN}}","https://github.com/{{DOMAIN}}"]}</script></head><body><header><h1>Welcome to {{DOMAIN}}</h1><nav><ul><li><a href="/services">Services</a></li><li><a href="/about">About</a></li><li><a href="/portfolio">Portfolio</a></li><li><a href="/blog">Blog</a></li><li><a href="/contact">Contact</a></li></ul></nav></header><main><section><h2>ğŸ› ï¸ Our Services</h2><ul><li><strong>Web Development:</strong> Modern, responsive websites and web applications</li><li><strong>Mobile Applications:</strong> Cross-platform mobile solutions for iOS and Android</li><li><strong>Cloud Solutions:</strong> Scalable cloud architecture and migration services</li><li><strong>Digital Consulting:</strong> Strategic technology consulting for digital transformation</li><li><strong>Software Integration:</strong> API development and third-party integrations</li><li><strong>Maintenance & Support:</strong> Ongoing technical support and system maintenance</li></ul></section><section><h2>ğŸ’¡ Why Choose Us</h2><p>With extensive experience in modern technology solutions, we deliver high-quality, scalable results that drive business growth. Our team specializes in:</p><ul><li>âœ… Agile development methodologies</li><li>âœ… Cloud-native architectures</li><li>âœ… Security-first approach</li><li>âœ… Performance optimization</li><li>âœ… Continuous integration and deployment</li></ul></section><section><h2>ğŸ¢ Industry Experience</h2><p>We have successfully delivered projects across various industries including:</p><p><strong>E-commerce, FinTech, HealthTech, Education, Enterprise SaaS, Media & Entertainment</strong></p></section><section><h2>ğŸ“ Contact Information</h2><p>Ready to discuss your next project? Get in touch with our team:</p><ul><li>ğŸ“§ Email: contact@{{DOMAIN}}</li><li>ğŸ“ Phone: Available upon request</li><li>ğŸŒ Website: https://{{DOMAIN}}:{{NGINX_PORT}}</li><li>ğŸ“ Serving clients globally</li></ul></section></main><footer><p>&copy; 2024 {{DOMAIN}}. All rights reserved.</p><nav><ul><li><a href="/privacy">Privacy Policy</a></li><li><a href="/terms">Terms of Service</a></li><li><a href="/sitemap.xml">Sitemap</a></li></ul></nav></footer></body></html>';
            add_header Content-Type text/html;
            add_header Cache-Control "public, max-age=7200";
        }

        # ä¸»é¡µé¢è·¯ç”±é€»è¾‘ - åŠ¨æ€å†…å®¹ç”Ÿæˆ
        location / {
            # æœç´¢å¼•æ“çˆ¬è™«ä¼˜å…ˆå¤„ç†ï¼ˆSEOä¼˜åŒ–ï¼‰
            if ($user_agent_type = "bot") {
                try_files $uri @bot_page;
            }
            
            # æ ¹æ®æ—¶é—´æ®µé€‰æ‹©ä¸åŒçš„ç½‘ç«™ç±»å‹
            if ($page_type = "tech") {
                try_files $uri @tech_blog;
            }
            if ($page_type = "company") {
                try_files $uri @company_site;
            }
            if ($page_type = "portfolio") {
                try_files $uri @portfolio_site;
            }
            
            # é»˜è®¤å›é€€åˆ°æŠ€æœ¯åšå®¢é¡µé¢
            try_files $uri @tech_blog;
        }

        # å¥åº·æ£€æŸ¥æ¥å£
        location /health {
            return 200 '{"status":"ok","timestamp":"$time_iso8601","tls":true}';
            add_header Content-Type application/json;
        }
    }

    # HTTP é‡å®šå‘åˆ° HTTPS
    server {
        listen 80;
        server_name {{DOMAIN}};
        
        # ACME è´¨è¯¢è·¯å¾„
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }
        
        # å…¶ä»–è¯·æ±‚é‡å®šå‘åˆ° HTTPS
        location / {
            return 301 https://$server_name:{{NGINX_PORT}}$request_uri;
        }
    }
}